define("base/megapix_img",[],function(){function e(e){var t=e.naturalWidth,n=e.naturalHeight;if(t*n>1048576){var i=document.createElement("canvas");i.width=i.height=1;var a=i.getContext("2d");return a.drawImage(e,-t+1,0),0===a.getImageData(0,0,1,1).data[3]}return!1}function t(e,t,n){var i=document.createElement("canvas");i.width=1,i.height=n;var a=i.getContext("2d");a.drawImage(e,0,0);for(var o=a.getImageData(0,0,1,n).data,r=0,s=n,l=n;l>r;){var d=o[4*(l-1)+3];0===d?s=l:r=l,l=s+r>>1}var c=l/n;return 0===c?1:c}function n(e,t,n){var a=document.createElement("canvas");return i(e,a,t,n),a.toDataURL("image/jpeg",t.quality||.8)}function i(n,i,o,r){var s=n.naturalWidth,l=n.naturalHeight,d=o.width,c=o.height,_=i.getContext("2d");_.save(),a(i,d,c,o.orientation);var p=e(n);p&&(s/=2,l/=2);var u=1024,h=document.createElement("canvas");h.width=h.height=u;for(var f=h.getContext("2d"),m=r?t(n,s,l):1,g=Math.ceil(u*d/s),v=Math.ceil(u*c/l/m),w=0,b=0;l>w;){for(var x=0,y=0;s>x;)f.clearRect(0,0,u,u),f.drawImage(n,-x,-w),_.drawImage(h,0,0,u,u,y,b,g,v),x+=u,y+=g;w+=u,b+=v}_.restore(),h=f=null}function a(e,t,n,i){switch(i){case 5:case 6:case 7:case 8:e.width=n,e.height=t;break;default:e.width=t,e.height=n}var a=e.getContext("2d");switch(i){case 2:a.translate(t,0),a.scale(-1,1);break;case 3:a.translate(t,n),a.rotate(Math.PI);break;case 4:a.translate(0,n),a.scale(1,-1);break;case 5:a.rotate(.5*Math.PI),a.scale(1,-1);break;case 6:a.rotate(.5*Math.PI),a.translate(0,-n);break;case 7:a.rotate(.5*Math.PI),a.translate(t,-n),a.scale(-1,1);break;case 8:a.rotate(-.5*Math.PI),a.translate(-t,0);break;default:}}function o(e){if(e instanceof Blob){var t=new Image,n=window.URL&&window.URL.createObjectURL?window.URL:window.webkitURL&&window.webkitURL.createObjectURL?window.webkitURL:null;if(!n)throw Error("No createObjectURL function found to create blob url");t.src=n.createObjectURL(e),this.blob=e,e=t}if(!e.naturalWidth&&!e.naturalHeight){var i=this;e.onload=function(){var e=i.imageLoadListeners;if(e){i.imageLoadListeners=null;for(var t=0,n=e.length;n>t;t++)e[t]()}},this.imageLoadListeners=[]}this.srcImage=e}return o.prototype.render=function(e,t){if(this.imageLoadListeners){var a=this;return this.imageLoadListeners.push(function(){a.render(e,t)}),void 0}t=t||{};var o=this.srcImage.naturalWidth,r=this.srcImage.naturalHeight,s=t.width,l=t.height,d=t.maxWidth,c=t.maxHeight,_=!this.blob||"image/jpeg"===this.blob.type;s&&!l?l=r*s/o<<0:l&&!s?s=o*l/r<<0:(s=o,l=r),d&&s>d&&(s=d,l=r*s/o<<0),c&&l>c&&(l=c,s=o*l/r<<0);var p={width:s,height:l};for(var u in t)p[u]=t[u];var h=e.tagName.toLowerCase();"img"===h?(e.src=n(this.srcImage,p,_),"function"==typeof t.render_callback&&t.render_callback.call(this,e.src)):"canvas"===h&&i(this.srcImage,e,p,_),"function"==typeof this.onrender&&this.onrender(e)},o});